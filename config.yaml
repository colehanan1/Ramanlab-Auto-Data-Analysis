
# Project configuration
model_path: "/home/ramanlab/Documents/cole/sam2/notebooks/YOLOProjectProboscisLegs/runs/obb/train5/weights/best.pt"
main_directory:
          - "/home/ramanlab/Documents/cole/Data/flys/Benz_control/"
          - "/home/ramanlab/Documents/cole/Data/flys/EB_control/"
          - "/home/ramanlab/Documents/cole/Data/flys/hex_control/"
          - "/home/ramanlab/Documents/cole/Data/flys/opto_ACV/"
          - "/home/ramanlab/Documents/cole/Data/flys/opto_AIR/"
          - "/home/ramanlab/Documents/cole/Data/flys/opto_benz_1/"
          - "/home/ramanlab/Documents/cole/Data/flys/opto_EB/"
          - "/home/ramanlab/Documents/cole/Data/flys/opto_EB(6-training)/"
          - "/home/ramanlab/Documents/cole/Data/flys/opto_hex/"
          - "/home/ramanlab/Documents/cole/Data/flys/opto_3-oct/"

cache_dir: "/home/ramanlab/Documents/cole/cache"
force:
  pipeline: true  # Set to true to force full reprocessing (bypasses cache)
  yolo: false      # Set to true to rerun YOLO inference even if outputs exist
  combined: false  # Set to true to force reprocessing of combined analysis
  reaction_prediction: true  # Set to true to force model re-prediction
  reaction_matrix: true      # Set to true to force matrix regeneration

reaction_prediction:
  data_csv: "/home/ramanlab/Documents/cole/Data/Opto/Combined/all_envelope_rows_wide.csv"
  model_path: "/home/ramanlab/Documents/cole/VSCode/FlyBehaviorScoring/artifacts/2025-12-10T20-37-33Z/model_random_forest.joblib"
  output_csv: "/home/ramanlab/Documents/cole/Data/Opto/Combined/model_predictions.csv"
  threshold: 0.35
  matrix:
    out_dir: "/home/ramanlab/Documents/cole/Results/Opto/Reaction_Predictions(Strictest)"
    latency_sec: 2.15
    after_window_sec: 30.0
    row_gap: 0.6
    height_per_gap_in: 3.0
    bottom_shift_in: 0.5
    trial_orders: ["observed", "trained-first"]
    include_hexanol: true
    overwrite: false

# Compute
allow_cpu: false
cuda_allow_tf32: true

# Detection / tracking
yolo:
  conf_thres: 0.40
  iou_match_thres: 0.25
  max_age: 5
  ema_alpha: 0.20
  use_optical_flow: false
  flow_skip_edge: 10
  max_flies: 3
  max_proboscis_tracks: 3
  pair_rebind_ratio: 0.20
  zero_iou_epsilon: 1.0e-8

# Geometry
anchor_x: 1079.0
anchor_y: 540.0

# Distance stats
distance_limits:
  class2_min: 10.0
  class2_max: 250.0

# Reaction filtering
non_reactive_span_px: 7.5  # flag flies when global span â‰¤ this threshold (pixels)

# Tracking quality filtering
tracking:
  max_missing_frames_per_trial: 5000  # Flag if any trial has >5000 frames without proboscis detection
  max_missing_frames_pct_per_trial: 50.0  # Flag if >50% of trial frames lack detection
  apply_missing_frame_check: true  # Enable/disable tracking quality check

# YOLO Dataset Curation
yolo_curation:
  enabled: true  # Enable/disable curation module (set to true to start curating)
  quality_thresholds:
    max_jitter_px: 20.0  # Flag videos with median jitter > 20 pixels (lowered to get more images)
    max_missing_pct: 0.05  # Flag videos with >5% frames missing proboscis detection (lowered to get more images)
  target_frames:
    per_video: 15  # Extract ~10 frames per flagged video
    total: 300  # Target total frames to extract (not yet enforced)
    stratification:
      high_quality: 0.30  # 30% from high-quality regions (low jitter, valid tracking)
      low_quality: 0.50  # 50% from low-quality regions (high jitter or missing)
      boundary: 0.20  # 20% from boundary regions (moderate quality)
  augmentation:
    enabled: true
    strategies:
      - horizontal_flip
      - brightness_contrast_jitter
      - minor_rotation
    multiplier: 2  # Aim for 2x dataset size via augmentation
  output_dir: "yolo_curation"  # Directory name (relative to FLY_DIR)
  video_source_dirs:  # Additional directories to search for videos (e.g., secure storage)
    - "/securedstorage/DATAsec/cole/Data-secured/opto_EB/"
    - "/securedstorage/DATAsec/cole/Data-secured/opto_EB(6-training)/"
    - "/securedstorage/DATAsec/cole/Data-secured/opto_benz_1/"
    - "/securedstorage/DATAsec/cole/Data-secured/opto_hex/"
    - "/securedstorage/DATAsec/cole/Data-secured/opto_ACV/"
    - "/securedstorage/DATAsec/cole/Data-secured/hex_control/"
    - "/securedstorage/DATAsec/cole/Data-secured/EB_control/"
    - "/securedstorage/DATAsec/cole/Data-secured/Benz_control/"
    - "/securedstorage/DATAsec/cole/Data-secured/opto_AIR/"
    - "/securedstorage/DATAsec/cole/Data-secured/opto_3-oct/"

# Envelope / RMS
fps_default: 40.0
window_sec: 0.25
odor_on_s: 30.0
odor_off_s: 60.0
odor_latency_s: 2.15

# Videos
delete_source_after_render: true

analysis:
  envelope_visuals:
    matrices:
      matrix_npy: "/home/ramanlab/Documents/cole/Data/Opto/Combined/matrix/envelope_matrix_float16.npy"
      codes_json: "/home/ramanlab/Documents/cole/Data/Opto/Combined/matrix/code_maps.json"
      out_dir: "/home/ramanlab/Documents/cole/Results/Opto/Reaction_Matrices"
      latency_sec: 0.0
      fps_default: 40.0
      before_sec: 30.0
      during_sec: 30.0
      after_window_sec: 30.0
      threshold_std_mult: 4.0
      min_samples_over: 20
      row_gap: 0.6
      height_per_gap_in: 3.0
      bottom_shift_in: 0.5
      trial_orders: ["observed", "trained-first"]
      include_hexanol: true
      overwrite: true
    envelopes:
      matrix_npy: "/home/ramanlab/Documents/cole/Data/Opto/Combined/matrix/envelope_matrix_float16.npy"
      codes_json: "/home/ramanlab/Documents/cole/Data/Opto/Combined/matrix/code_maps.json"
      out_dir: "/home/ramanlab/Documents/cole/Results/Opto/PER-Envelopes"
      latency_sec: 0.0
      fps_default: 40.0
      odor_on_s: 30.0
      odor_off_s: 60.0
      odor_latency_s: 2.15
      after_show_sec: 30.0
      threshold_std_mult: 4.0
      trial_type: testing
      overwrite: false
  training:
    envelopes:
      matrix_npy: "/home/ramanlab/Documents/cole/Data/Opto/Combined/matrix/training/envelope_matrix_float16.npy"
      codes_json: "/home/ramanlab/Documents/cole/Data/Opto/Combined/matrix/training/code_maps.json"
      out_dir: "/home/ramanlab/Documents/cole/Results/Opto/Training-PER-Envelopes"
      latency_sec: 0.0
      fps_default: 40.0
      odor_on_s: 30.0
      odor_off_s: 60.0
      odor_latency_s: 2.15
      after_show_sec: 30.0
      threshold_std_mult: 4.0
      trial_type: training
      overwrite: false
    latency:
      matrix_npy: "/home/ramanlab/Documents/cole/Data/Opto/Combined/matrix/training/envelope_matrix_float16.npy"
      codes_json: "/home/ramanlab/Documents/cole/Data/Opto/Combined/matrix/training/code_maps.json"
      out_dir: "/home/ramanlab/Documents/cole/Results/Opto/Training-Latency"
      before_sec: 30.0
      during_sec: 35.0
      threshold_mult: 4.0
      latency_ceiling: 9.5
      trials: [4, 5, 6]
      fps_default: 40.0
      overwrite: false
  combined:
    combine:
      roots:
        - "/home/ramanlab/Documents/cole/Data/flys/opto_benz_1/"
        - "/home/ramanlab/Documents/cole/Data/flys/hex_control/"
        - "/home/ramanlab/Documents/cole/Data/flys/EB_control/"
        - "/home/ramanlab/Documents/cole/Data/flys/Benz_control/"
        - "/home/ramanlab/Documents/cole/Data/flys/opto_EB/"
        - "/home/ramanlab/Documents/cole/Data/flys/opto_EB(6-training)/"
        - "/home/ramanlab/Documents/cole/Data/flys/opto_hex/"
        - "/home/ramanlab/Documents/cole/Data/flys/opto_ACV/"
        - "/home/ramanlab/Documents/cole/Data/flys/opto_AIR/"
        - "/home/ramanlab/Documents/cole/Data/flys/opto_3-oct/"

      fps_default: 40.0
      window_sec: 0.25
      odor_on: 30.0
      odor_off: 60.0
      odor_latency_s: 2.15
    wide:
      mirror:
        - source: "/home/ramanlab/Documents/cole/Data/flys/opto_hex/"
          destination: "/securedstorage/DATAsec/cole/Data-secured/opto_hex/"
        - source: "/home/ramanlab/Documents/cole/Data/flys/opto_ACV/"
          destination: "/securedstorage/DATAsec/cole/Data-secured/opto_ACV/"
        - source: "/home/ramanlab/Documents/cole/Data/flys/opto_EB(6-training)/"
          destination: "/securedstorage/DATAsec/cole/Data-secured/opto_EB(6-training)/"
      roots:
        - "/securedstorage/DATAsec/cole/Data-secured/opto_EB/"
        - "/securedstorage/DATAsec/cole/Data-secured/opto_EB(6-training)/"
        - "/securedstorage/DATAsec/cole/Data-secured/opto_benz_1/"
        - "/securedstorage/DATAsec/cole/Data-secured/opto_hex/"
        - "/securedstorage/DATAsec/cole/Data-secured/opto_ACV/"
        - "/securedstorage/DATAsec/cole/Data-secured/hex_control/"
        - "/securedstorage/DATAsec/cole/Data-secured/EB_control/"
        - "/securedstorage/DATAsec/cole/Data-secured/Benz_control/"
        - "/securedstorage/DATAsec/cole/Data-secured/opto_AIR/"
        - "/securedstorage/DATAsec/cole/Data-secured/opto_3-oct/"
      output_csv: "/home/ramanlab/Documents/cole/Data/Opto/Combined/all_envelope_rows_wide.csv"
      measure_cols: ["envelope_of_rms"]
      fps_fallback: 40.0
      trial_type_exports:
        - trial_type: training
          output_csv: "/home/ramanlab/Documents/cole/Data/Opto/Combined/all_envelope_rows_wide_training.csv"
          matrix_out_dir: "/home/ramanlab/Documents/cole/Data/Opto/Combined/matrix/training"
    matrix:
      input_csv: "/home/ramanlab/Documents/cole/Data/Opto/Combined/all_envelope_rows_wide.csv"
      out_dir: "/home/ramanlab/Documents/cole/Data/Opto/Combined/matrix"
    matrices:
      matrix_npy: "/home/ramanlab/Documents/cole/Data/Opto/Combined/matrix/envelope_matrix_float16.npy"
      codes_json: "/home/ramanlab/Documents/cole/Data/Opto/Combined/matrix/code_maps.json"
      out_dir: "/home/ramanlab/Documents/cole/Results/Opto/Reaction_Matrices"
      latency_sec: 0.0
      fps_default: 40.0
      before_sec: 30.0
      during_sec: 30.0
      after_window_sec: 30.0
      threshold_std_mult: 4.0
      min_samples_over: 20
      row_gap: 0.6
      height_per_gap_in: 3.0
      bottom_shift_in: 0.5
      trial_orders: ["observed", "trained-first"]
      include_hexanol: true
      overwrite: true
    envelopes:
      - matrix_npy: "/home/ramanlab/Documents/cole/Data/Opto/Combined/matrix/envelope_matrix_float16.npy"
        codes_json: "/home/ramanlab/Documents/cole/Data/Opto/Combined/matrix/code_maps.json"
        out_dir: "/home/ramanlab/Documents/cole/Results/Opto/PER-Envelopes"
        latency_sec: 0.0
        fps_default: 40.0
        odor_on_s: 30.0
        odor_off_s: 60.0
        odor_latency_s: 2.15
        after_show_sec: 30.0
        threshold_std_mult: 4.0
        overwrite: false
      - matrix_npy: "/home/ramanlab/Documents/cole/Data/Opto/Combined/matrix/training/envelope_matrix_float16.npy"
        codes_json: "/home/ramanlab/Documents/cole/Data/Opto/Combined/matrix/training/code_maps.json"
        out_dir: "/home/ramanlab/Documents/cole/Results/Opto/Training-PER-Envelopes"
        latency_sec: 0.0
        fps_default: 40.0
        odor_on_s: 30.0
        odor_off_s: 60.0
        odor_latency_s: 2.15
        after_show_sec: 30.0
        threshold_std_mult: 4.0
        trial_type: training
        overwrite: false
    overlay:
      combined_matrix: "/home/ramanlab/Documents/cole/Data/Opto/Combined/matrix/envelope_matrix_float16.npy"
      combined_codes: "/home/ramanlab/Documents/cole/Data/Opto/Combined/matrix/code_maps.json"
      distance_matrix: "/home/ramanlab/Documents/cole/Data/single_matrix_opto/envelope_matrix_float16.npy"
      distance_codes: "/home/ramanlab/Documents/cole/Data/single_matrix_opto/code_maps.json"
      out_dir: "/home/ramanlab/Documents/cole/Results/Opto/Reaction_Matrices/Overlay"
      latency_sec: 0.0
      after_show_sec: 30.0
      threshold_std_mult: 4.0
      odor_on_s: 30.0
      odor_off_s: 60.0
      odor_latency_s: 2.15
      overwrite: false
    secure_cleanup:
      destination: "/securedstorage/DATAsec/cole/Data-secured/"
      sources:
        - "/home/ramanlab/Documents/cole/Data/flys/opto_EB/"
        - "/home/ramanlab/Documents/cole/Data/flys/opto_EB(6-training)/"
        - "/home/ramanlab/Documents/cole/Data/flys/opto_benz_1/"
        - "/home/ramanlab/Documents/cole/Data/flys/opto_hex/"
        - "/home/ramanlab/Documents/cole/Data/flys/opto_ACV/"
        - "/home/ramanlab/Documents/cole/Data/flys/hex_control/"
        - "/home/ramanlab/Documents/cole/Data/flys/EB_control/"
        - "/home/ramanlab/Documents/cole/Data/flys/Benz_control/"
        - "/home/ramanlab/Documents/cole/Data/flys/opto_AIR/"
        - "/home/ramanlab/Documents/cole/Data/flys/opto_3-oct/"
